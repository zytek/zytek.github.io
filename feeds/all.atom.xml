<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom"><title>@zytek</title><link href="http://blog.nuxi.pl/" rel="alternate"></link><link href="http://blog.nuxi.pl/feeds/all.atom.xml" rel="self"></link><id>http://blog.nuxi.pl/</id><updated>2015-10-03T00:00:00+02:00</updated><entry><title>Git Tip of the Day: count number of lines of code in repository</title><link href="http://blog.nuxi.pl/2015/tip-git-lines-of-code-alias.html" rel="alternate"></link><updated>2015-10-03T00:00:00+02:00</updated><author><name>Jakub Paweł Głazik</name></author><id>tag:blog.nuxi.pl,2015-10-03:2015/tip-git-lines-of-code-alias.html</id><summary type="html">&lt;p&gt;How to count number of lines of code in a Git repository?
Add this alias to your ~/.gitconfig&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;[alias]
    loc = diff --stat 4b825dc642cb6eb9a060e54bf8d69288fbee4904
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;This shows diff against empty repository (&lt;code&gt;git hash-object -t tree /dev/null&lt;/code&gt;)&lt;/p&gt;
&lt;p&gt;Now you can just type &lt;code&gt;git loc&lt;/code&gt; and get an answer. This is nice as it does not take binary files into account when counting lines.&lt;/p&gt;</summary><category term="linux"></category><category term="git"></category><category term="tips"></category></entry><entry><title>AWS Tip Of The Day: Get S3 disk usage per bucket</title><link href="http://blog.nuxi.pl/2015/aws-tip-of-the-day-get-s3-disk-usage-per-bucket.html" rel="alternate"></link><updated>2015-04-28T00:00:00+02:00</updated><author><name>Jakub Paweł Głazik</name></author><id>tag:blog.nuxi.pl,2015-04-28:2015/aws-tip-of-the-day-get-s3-disk-usage-per-bucket.html</id><summary type="html">&lt;p&gt;Getting &lt;em&gt;disk usage&lt;/em&gt; statistics for Amazon S3 buckets is not that easy.
Things are quite simple when your objects count and data size is reasonable and by 
reasonable I mean something around &lt;strong&gt;&amp;lt; 10 TB&lt;/strong&gt; and  &lt;strong&gt;&amp;lt; 1000&lt;/strong&gt; objects per bucket.&lt;/p&gt;
&lt;p&gt;You can either use &lt;a href="https://github.com/bloomreach/s4cmd"&gt;s4cmd&lt;/a&gt; (fast, multi threaded)&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;s4cmd du -r s3://dbbackups/
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;or AWS Cli tools&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;aws s3api list-objects --bucket dbbackups --output json --query &amp;quot;[sum(Contents[].Size), length(Contents[])]&amp;quot;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;But when your buckets have &lt;strong&gt;&amp;gt;30000&lt;/strong&gt; objects totaling at &lt;strong&gt;hunderds of terabytes&lt;/strong&gt;, then
those api calls are slow. Really slow. One solution that works for me is to use
AWS Usage Reports to generate report for &lt;em&gt;the last full day&lt;/em&gt; and then parse this report
using bash one liner.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;cat report.csv &lt;span class="p"&gt;|&lt;/span&gt; awk -F, &lt;span class="s1"&gt;&amp;#39;{printf &amp;quot;%.2f GB %s %s \n&amp;quot;, $7/(1024**3 )/24, $4, $2}&amp;#39;&lt;/span&gt; &lt;span class="p"&gt;|&lt;/span&gt; sort -n
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;This converts CSV file into a list that displays disk usage in GB, one line per bucket.
Values presented in the original report are in Byte-Hours per day and you can read more about it 
on &lt;a href="http://aws.amazon.com/s3/faqs/#billing_anchor"&gt;official AWS S3 Billing FAQ entry&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;To obtain S3 Usage reports follow these steps&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Go to &lt;a href="https://portal.aws.amazon.com/gp/aws/developer/account/index.html?action=usage-report"&gt;AWS Usage Reports&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;Select &lt;em&gt;Amazon Simple Storage Service&lt;/em&gt;&lt;/li&gt;
&lt;li&gt;Select &lt;em&gt;TimedStorage-ByteHrs&lt;/em&gt;&lt;/li&gt;
&lt;li&gt;Select Custom date range, fill for last day&lt;/li&gt;
&lt;li&gt;Download CSV&lt;/li&gt;
&lt;li&gt;Apply above bash one liner for downloaded report file&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;&lt;img alt="S3 Usage Report" src="http://blog.nuxi.pl/images/s3-usage-report.png" /&gt;&lt;/p&gt;
&lt;p&gt;I'll update this post if I'll come up with some automated solution. &lt;/p&gt;</summary><category term="aws"></category><category term="s3"></category><category term="tips"></category></entry><entry><title>Fix ElastiSearch stuck with unassigned shards</title><link href="http://blog.nuxi.pl/2015/fix-elastisearch-stuck-with-unassigned-shards.html" rel="alternate"></link><updated>2015-04-04T00:00:00+02:00</updated><author><name>Jakub Paweł Głazik</name></author><id>tag:blog.nuxi.pl,2015-04-04:2015/fix-elastisearch-stuck-with-unassigned-shards.html</id><summary type="html">&lt;p&gt;In case your ElasticSearch cluster is stuck with unassigned shards you might want to try rerouting them to some other node.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;curl -XGET http://localhost:9200/_cat/shards &lt;span class="p"&gt;|&lt;/span&gt; grep UNASSIGNED &lt;span class="p"&gt;|&lt;/span&gt; awk &lt;span class="s1"&gt;&amp;#39;{print $1 &amp;quot; &amp;quot; $2}&amp;#39;&lt;/span&gt; &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="k"&gt;while&lt;/span&gt; &lt;span class="nb"&gt;read&lt;/span&gt; -r index shard&lt;span class="p"&gt;;&lt;/span&gt; &lt;span class="k"&gt;do&lt;/span&gt;

    &lt;span class="nb"&gt;echo&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;Rerouting shard &lt;/span&gt;&lt;span class="nv"&gt;$shard&lt;/span&gt;&lt;span class="s2"&gt; from index &lt;/span&gt;&lt;span class="nv"&gt;$index&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;
    curl -XPOST &lt;span class="s1"&gt;&amp;#39;localhost:9200/_cluster/reroute&amp;#39;&lt;/span&gt; -d &lt;span class="s2"&gt;&amp;quot;{&lt;/span&gt;
&lt;span class="s2"&gt;        \&amp;quot;commands\&amp;quot; : [ {&lt;/span&gt;
&lt;span class="s2"&gt;              \&amp;quot;allocate\&amp;quot; : {&lt;/span&gt;
&lt;span class="s2"&gt;                  \&amp;quot;index\&amp;quot; : \&amp;quot;&lt;/span&gt;&lt;span class="nv"&gt;$index&lt;/span&gt;&lt;span class="s2"&gt;\&amp;quot;,&lt;/span&gt;
&lt;span class="s2"&gt;                  \&amp;quot;shard\&amp;quot; : &lt;/span&gt;&lt;span class="nv"&gt;$shard&lt;/span&gt;&lt;span class="s2"&gt;,&lt;/span&gt;
&lt;span class="s2"&gt;                  \&amp;quot;node\&amp;quot; : \&amp;quot;NODE-NAME\&amp;quot;&lt;/span&gt;
&lt;span class="s2"&gt;              }&lt;/span&gt;
&lt;span class="s2"&gt;            }&lt;/span&gt;
&lt;span class="s2"&gt;        ]&lt;/span&gt;
&lt;span class="s2"&gt;    }&amp;quot;&lt;/span&gt;
    sleep 5
&lt;span class="k"&gt;done&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;This should work for Elasticsearch 1.3.x and 1.4.x&lt;/p&gt;
&lt;p&gt;For big indexes with many shards you might want to route them to different nodes.
ElastiSearch will eventually distribute it evenly once they are initialized.&lt;/p&gt;
&lt;p&gt;Original article with solutions for stuck shards in ES is &lt;a href="https://t37.net/how-to-fix-your-elasticsearch-cluster-stuck-in-initializing-shards-mode.html"&gt;here&lt;/a&gt;&lt;/p&gt;</summary><category term="devops"></category><category term="elasticsearch"></category><category term="tips"></category></entry><entry><title>vagrant down</title><link href="http://blog.nuxi.pl/2014/vagrant-down.html" rel="alternate"></link><updated>2014-02-06T00:00:00+01:00</updated><author><name>Jakub Paweł Głazik</name></author><id>tag:blog.nuxi.pl,2014-02-06:2014/vagrant-down.html</id><summary type="html">&lt;p&gt;Why doesn't &lt;strong&gt;vagrant&lt;/strong&gt; provide &lt;code&gt;vagrant down&lt;/code&gt; command? And I need to &lt;em&gt;always&lt;/em&gt; check
how to stop my VM insted of just relaying on simple up-&amp;gt;down schema..&lt;/p&gt;
&lt;p&gt;Edit: gues I wasn't the only one ranting about it: &lt;a href="https://github.com/justindowning/vagrant-down"&gt;vagrant-down&lt;/a&gt;.&lt;/p&gt;</summary><category term="devops"></category><category term="rant"></category></entry><entry><title>OS X Tip of the Day: Getting GDB back on Maverics</title><link href="http://blog.nuxi.pl/2013/tip-osx-gdb-maverics.html" rel="alternate"></link><updated>2013-11-09T00:00:00+01:00</updated><author><name>Jakub Paweł Głazik</name></author><id>tag:blog.nuxi.pl,2013-11-09:2013/tip-osx-gdb-maverics.html</id><summary type="html">&lt;p&gt;XCode on Maverics switched to LLDB and CLANG. Although this is exciting news, it
screwed some utils that assume &lt;code&gt;gdb&lt;/code&gt; is available on your system. Well, it is
not - even if you had installed Command Line Tools. Fortunately, your local
brewery came to the rescue. Assuming you have installed &lt;a href="http://brew.sh"&gt;Homebrew&lt;/a&gt;
on your system (you should) install &lt;code&gt;gdb&lt;/code&gt; from &lt;em&gt;dupes&lt;/em&gt; repository:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="nv"&gt;$ &lt;/span&gt;brew install homebrew/dupes/gdb
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Next: &lt;code&gt;gdb&lt;/code&gt; must be signed and allowed to attach to other processes. Otherwise 
you'll get the following error:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;Unable to find Mach task port for process-id 28885: (os/kern) failure (0x5).
 (please check gdb is codesigned - see taskgated(8))
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;The best you can you is to follow offical guide here - &lt;a href="https://sourceware.org/gdb/wiki/BuildingOnDarwin"&gt;BuildingOnDarwin&lt;/a&gt;. It involes a little
bit of clicking but you should get it done easily. Comment if you experience issues.&lt;/p&gt;</summary><category term="osx"></category><category term="tips"></category></entry><entry><title>LXC Tip of the Day: network issues, connection lags</title><link href="http://blog.nuxi.pl/2013/tip-lxc-network-issues.html" rel="alternate"></link><updated>2013-05-31T00:00:00+02:00</updated><author><name>Jakub Paweł Głazik</name></author><id>tag:blog.nuxi.pl,2013-05-31:2013/tip-lxc-network-issues.html</id><summary type="html">&lt;p&gt;If you get strange network lags and issues while connecting to your LXC Container, be sure that a coworker didn't setup another container &lt;strong&gt;WITH THE SAME MAC ADDRESS&lt;/strong&gt; as yours container.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;lxc.network.hwaddr  = 00:FF:00:00:00:04
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;By the way, lxc-clone sux not taking care of hwaddr and paths in container config file while cloning.&lt;/p&gt;</summary><category term="linux"></category><category term="lxc"></category><category term="tips"></category></entry><entry><title>LVM Tip of the Day: cleaning volume groups after dirty eSATA storage removal</title><link href="http://blog.nuxi.pl/2013/tip-lvm-cleaning-volume-groups.html" rel="alternate"></link><updated>2013-04-11T00:00:00+02:00</updated><author><name>Jakub Paweł Głazik</name></author><id>tag:blog.nuxi.pl,2013-04-11:2013/tip-lvm-cleaning-volume-groups.html</id><summary type="html">&lt;p&gt;What if you trip on a eSATA storage cable and remove it dirty ?
LVM will be unhappy:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;[885874.582738] Buffer I/O error on device dm-3, logical block 26214384
[885874.582766] Buffer I/O error on device dm-3, logical block 26214384
[885874.582796] Buffer I/O error on device dm-3, logical block 26214398
[885874.582816] Buffer I/O error on device dm-3, logical block 26214398
[885874.582843] Buffer I/O error on device dm-3, logical block 0
[885874.582863] Buffer I/O error on device dm-3, logical block 0
[885874.582889] Buffer I/O error on device dm-3, logical block 1
[885874.582924] Buffer I/O error on device dm-3, logical block 26214399
[885874.583085] Buffer I/O error on device dm-3, logical block 26214399
[885874.583110] Buffer I/O error on device dm-3, logical block 26214399
[885874.592284] EXT3-fs (dm-3): error: unable to read superblock
[885874.644520] EXT2-fs (dm-3): error: unable to read superbl
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;The rescue:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;dmsetup remove devicename
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;And then re-attach your storage.&lt;/p&gt;</summary><category term="linux"></category><category term="lvm"></category><category term="tips"></category></entry><entry><title>OS X Tip of the Day: AirPlay audio glitches</title><link href="http://blog.nuxi.pl/2013/tip-osx-airplay-audio-glitches.html" rel="alternate"></link><updated>2013-01-22T00:00:00+01:00</updated><author><name>Jakub Paweł Głazik</name></author><id>tag:blog.nuxi.pl,2013-01-22:2013/tip-osx-airplay-audio-glitches.html</id><summary type="html">&lt;p&gt;Annoyed with AirPlay glitches when outputing Mac's sound to your Awesome Speakers connected to AppleTV? 
Tired of rebooting to fix AirPlay problems? Angry because issue is known for at least a few months and still no fix from Apple?&lt;/p&gt;
&lt;p&gt;Well fear not! Open Terminal and type: &lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="nv"&gt;$ &lt;/span&gt;sudo pkill coreaudiod
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;It will restart coreaudiod and fix audio glitches.&lt;/p&gt;
&lt;p&gt;PS. I love how Mac OS is still being *nix down under the hood.&lt;/p&gt;</summary><category term="osx"></category><category term="tips"></category></entry></feed>